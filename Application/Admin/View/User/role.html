
<include file="Public:header"/>
<style>
.box {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}
.box dt {
    margin-bottom: 10px;
}
.box dd {
    padding: 0 50px;
}
.box dd .cate-second {
    margin-bottom: 10px;
}
.layui-form-checkbox {
    height: 50px!important;
    line-height: normal!important;
    border: none!important;
    margin-right: 0;
    padding-right: 0;
    background: 0 0;
}
.box dd .cate-third {
    padding: 0 40px;
    margin-bottom: 10px;
}

</style>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/layui/css/layui.css" media="all">
<script type="text/javascript" src="__PUBLIC__/layui/layui.js"></script>
<div id="main-content">
    <div id="main" class="main">
        <div class="main-title-h">
            <span class="h1-title">权限添加</span>
        </div>
        <div class="tab-wrap">
            <div class="tab-content">
                    <form class="layui-form" action="">
                        <input type="hidden" name="id" value="{$admin.id}">
                      <div class="mainBox">
                        <div class="main-container">
                          <div class="layui-form-item">
                            <label class="layui-form-label">用户名</label>
                            <div class="layui-word-aux layui-form-mid">{$admin.username}</div>
                          </div>
                          <div class="layui-form-item">
                            <label class="layui-form-label">昵称</label>
                            <div class="layui-word-aux layui-form-mid">{$admin.nickname}</div>
                          </div>
                          <div class="layui-form-item">
                            <label for="" class="layui-form-label">权限</label>
                            <div class="layui-input-block">
                              <foreach name="permissions" item="k">
                                
                              <dl class="box">
                                <dt>
                     
                                      <input id="menu{$k['id']}" type="checkbox" name="permissions" value="{$k['id']}" title="{$k['title']}" lay-skin="primary"  <if condition="isset($k['checked']) && $k['checked'] "> checked </if> >
                       
                                </dt>
                                <if condition="isset($k['_child']) && !empty($k['_child'])" >
                                
                                
                                <dd>
                                     <foreach name="k['_child']" item="v">
                                          <input id="menu{$k['id']}-{$v['id']}" type="checkbox" name="permissions" value="{$v['id']}" title="{$v['title']}" lay-skin="primary"  <if condition="isset($v['checked']) && $v['checked']"> checked </if> >
                                          <if condition="isset($v['_child']) && !empty($v['_child'])">
                                              <div class="cate-third">
                                                <foreach name="v['_child']" item="i">
                                                <input type="checkbox" id="menu{$k['id']}-{$v['id']}-{$i['id']}" name="permissions" value="{$i['id']}" title="{$i['title']}" lay-skin="primary" <if condition="isset($i['own']) && $i['own']"> checked </if> >
                                                </foreach>
                                              </div>
                                            </if>
                                   </foreach>
                                </dd>
                                
                                </if>
                              </dl>
                               </foreach>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="bottom">
                        <div class="button-container">
                          <button type="submit" class="layui-btn layui-btn-normal layui-btn-sm" lay-submit="" lay-filter="save">
                            <i class="layui-icon layui-icon-ok"></i>
                            提交
                          </button>
                          <button type="reset" class="layui-btn layui-btn-primary layui-btn-sm">
                            <i class="layui-icon layui-icon-refresh"></i>
                            重置
                          </button>
                        </div>
                      </div>
                    </form>
            </div>  
        </div>
    </div>
</div>
<block name="script">
    <script>
  layui.use(['form','jquery'],function(){
    let layform = layui.form;
    let $ = layui.jquery;
    layform.on('checkbox', function (data) {
      var check = data.elem.checked;//是否选中
      var checkId = data.elem.id;//当前操作的选项框
              console.log(checkId);
      if (check) {
        //选中
        var ids = checkId.split("-");

        if (ids.length == 3) {
          //第三极菜单
          //第三极菜单选中,则他的上级选中
          $("#" + (ids[0] + '-' + ids[1])).prop("checked", true);
          $("#" + (ids[0])).prop("checked", true);
        } else if (ids.length == 2) {
          //第二季菜单
          $("#" + (ids[0])).prop("checked", true);
          $("input[id*=" + ids[0] + '-' + ids[1] + "]").each(function (i, ele) {
            $(ele).prop("checked", true);
          });
        } else {
          //第一季菜单不需要做处理
          $("input[id*=" + ids[0] + "-]").each(function (i, ele) {
            $(ele).prop("checked", true);
          });
        }
      } else {
        //取消选中
        var ids = checkId.split("-");
        if (ids.length == 2) {
          //第二极菜单
          $("input[id*=" + ids[0] + '-' + ids[1] + "]").each(function (i, ele) {
            $(ele).prop("checked", false);
          });
        } else if (ids.length == 1) {
          $("input[id*=" + ids[0] + "-]").each(function (i, ele) {
            $(ele).prop("checked", false);
          });
        }
      }
      layform.render();
    });

    layform.on('submit(save)', function(data){
         var arr_check = [];
          $("input:checkbox[name='permissions']:checked").each(function() {
            arr_check.push($(this).val());  //获取checkbox name=prjtrsc 的所有选中值
        });
        data.field.permissions = arr_check; //替换到
      $.ajax({
        data:data.field,
        type:'post',
        success:function(res){
          //判断有没有权限
          if(res.status){
            layer.msg(res.info,{icon:1,time:1000});
          }else{
            layer.msg(res.info,{icon:2,time:1000});
          }
        }
      })
      return false;
    });
  })
</script>
</block>
<include file="Public:footer"/>
