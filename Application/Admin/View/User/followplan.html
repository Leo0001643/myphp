<include file="Public:header" />

<div class="main-content">
    <div class="row">
        <div class="col-md-12">
            <div class="widget">
                <div class="widget-header bordered-bottom bordered-blue">
                    <span class="widget-caption">秒合约跟单计划</span>
                    <div class="widget-buttons">
                        <a href="{:U('User/followplanAdd')}" class="btn btn-primary btn-sm">发布跟单计划</a>
                    </div>
                </div>
                <div class="widget-body">
                    <form class="form-inline" method="get" action="">
                        <label>状态：</label>
                        <select name="status" class="form-control input-sm">
                            <option value="">全部</option>
                            <option value="1" <eq name="Think.get.status" value="1">selected</eq>>可跟随</option>
                            <option value="2" <eq name="Think.get.status" value="2">selected</eq>>已结束</option>
                            <option value="3" <eq name="Think.get.status" value="3">selected</eq>>已取消</option>
                        </select>
                        <button class="btn btn-primary btn-sm" type="submit">搜索</button>
                    </form>
                    <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>投放范围</th>
                                <th>批次</th>
                                <th>标题</th>
                                <th>交易对</th>
                                <th>周期(秒)</th>
                                <th>金额</th>
                                <th>百分比</th>
                                <th>倒计时</th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                                <th>方向</th>
                                <th>控盈亏</th>
                                <th>状态</th>
                                <th>跟随次数</th>
                                <th>真实跟随</th>
                                <th>创建时间</th>
                            </tr>
                        </thead>
                        <tbody>
                        <volist name="list" id="vo">
                            <tr>
                                <td>{$vo.id}</td>
                                <td>
                                    <if condition="$vo.target_type eq 0">全部用户
                                    <elseif condition="$vo.target_type eq 1" />代理线
                                    <elseif condition="$vo.target_type eq 2" />指定用户
                                    </if>
                                    <br/>
                                    <small>
                                    <if condition="$vo.target_type eq 1">
                                        <if condition="$vo.target_expanded eq 1">
                                            <span title="已展开">已展开</span>
                                        <else/>
                                            <span title="未展开">未展开</span>
                                        </if>
                                    </if>
                                    </small>
                                </td>
                                <td>{$vo.batch_no}</td>
                                <td>{$vo.title}</td>
                                <td>{$vo.coinname}</td>
                                <td>{$vo.period}</td>
                                <td>{$vo.amount}</td>
                                <td><if condition="$vo.percent gt 0">{$vo.percent}%<else/>--</if></td>
                                <td class="cd-cell" data-end="<if condition='$vo.end_time'>{$vo.end_time|strtotime}000<else />0</if>" data-status="{$vo.status}">--</td>
                                <td>{$vo.start_time}</td>
                                <td>{$vo.end_time}</td>
                                <td><eq name="vo.direction" value="1">买涨<else/>买跌</eq></td>
                                <td><eq name="vo.kongyk" value="1">盈利<elseif condition="$vo.kongyk eq 2" />亏损<else/>不控制</eq></td>
                                <td class="status-cell" data-end="<if condition='$vo.end_time'>{$vo.end_time|strtotime}000<else />0</if>" data-status="{$vo.status}">
                                    <span class="status-display">
                                        <eq name="vo.status" value="1">可跟随<elseif condition="$vo.status eq 2" />已结束<else/>已取消</eq>
                                    </span>
                                </td>
                                <td>{$vo.follow_count}</td>
                                <td>{$vo.follow_real}</td>
                                <td>{$vo.created_at}</td>
                            </tr>
                        </volist>
                        </tbody>
                    </table>
                    <div>{$page}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="serverNowTs" value="{:time()}" />
<script type="text/javascript">
(function(){
    var serverNowInput = document.getElementById('serverNowTs');
    if(!serverNowInput){return;}
    var serverNowMs = parseInt(serverNowInput.value, 10) * 1000;
    var perfStart = performance.now();

    // if server timestamp is stale compared to client, request fresh server time
    try {
        var clientNowSec = Math.floor(Date.now()/1000);
        var serverNowSec = parseInt(serverNowInput.value,10);
        if(!isNaN(serverNowSec) && Math.abs(clientNowSec - serverNowSec) > 10){
            // fetch fresh server time (lightweight)
            var xhr = new XMLHttpRequest();
            xhr.open('GET', "{:U('User/serverTime')}", true);
            xhr.onreadystatechange = function(){
                if(xhr.readyState === 4 && xhr.status === 200){
                    try{
                        var j = JSON.parse(xhr.responseText);
                        if(j && j.time){
                            serverNowMs = parseInt(j.time,10) * 1000;
                            // reset perfStart so further performance.now() delta is relative
                            perfStart = performance.now();
                            serverNowInput.value = j.time;
                        }
                    }catch(e){}
                }
            };
            xhr.send(null);
        }
    }catch(e){}

    function format(ms){
        var total = Math.floor(ms/1000);
        var h = Math.floor(total / 3600);
        var m = Math.floor((total % 3600) / 60);
        var s = total % 60;
        return [h,m,s].map(function(n){return n < 10 ? '0'+n : ''+n;}).join(':');
    }

    function tick(){
        var now = serverNowMs + (performance.now() - perfStart);
        var nodes = document.querySelectorAll('.cd-cell');
        nodes.forEach(function(el){
            var status = el.getAttribute('data-status');
            var endTs = parseInt(el.getAttribute('data-end'),10);
            if(status && status !== '1'){
                el.textContent = '已过期';
                return;
            }
            if(!endTs){
                el.textContent = '--';
                return;
            }
            var diff = endTs - now;
            if(diff <= 0){
                el.textContent = '已过期';
                el.setAttribute('data-status','2');
            }else{
                el.textContent = format(diff);
            }
        });
    }

    tick();
    setInterval(tick, 1000);
})();
</script>

<include file="Public:footer" />

<script type="text/javascript">
// Auto-refresh status display using server time
(function(){
    var perfBase = performance.now();
    var serverNowMs = parseInt(document.getElementById('serverNowTs').value,10) * 1000;
    function fetchServerTime(cb){
        var xhr = new XMLHttpRequest();
        xhr.open('GET', "{:U('User/serverTime')}", true);
        xhr.onreadystatechange = function(){
            if(xhr.readyState===4 && xhr.status===200){
                try{
                    var j = JSON.parse(xhr.responseText);
                    if(j && j.time){
                        serverNowMs = parseInt(j.time,10) * 1000;
                        perfBase = performance.now();
                        if(typeof cb === 'function') cb();
                    }
                }catch(e){}
            }
        };
        xhr.send(null);
    }

    function nowMs(){ return serverNowMs + (performance.now() - perfBase); }
    function updateStatuses(){
        var nodes = document.querySelectorAll('.status-cell');
        var n = nowMs();
        nodes.forEach(function(cell){
            var endTs = parseInt(cell.getAttribute('data-end'),10) || 0;
            var statusAttr = cell.getAttribute('data-status') || '';
            var display = cell.querySelector('.status-display');
            if(endTs && endTs <= n){
                // expired
                if(display) display.textContent = '已结束';
                cell.setAttribute('data-status','2');
                // also update any cd-cell in same row
                var tr = cell.closest('tr');
                if(tr){
                    var cd = tr.querySelector('.cd-cell');
                    if(cd) cd.textContent = '已过期';
                }
            }else{
                // not expired: show original if status=1
                if(statusAttr == '1' || statusAttr == ''){
                    if(display) display.textContent = '可跟随';
                    cell.setAttribute('data-status','1');
                }
            }
        });
    }

    // initial update and periodic refresh
    fetchServerTime(function(){ updateStatuses(); });
    document.addEventListener('visibilitychange', function(){
        if(!document.hidden){
            fetchServerTime(updateStatuses);
        }
    });
    setInterval(function(){ fetchServerTime(updateStatuses); }, 30000); // every 30s
})();
</script>

