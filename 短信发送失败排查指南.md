# 短信发送失败排查步骤

## 🔍 当前状态

错误信息：`{code: 0, info: "短信发送失败"}`

**好消息**：代码已经正确执行到API调用了！
**问题**：API返回了错误响应

---

## 🧪 立即执行：运行测试脚本

在服务器上运行：

```bash
cd /www/wwwroot/168stoneex.com
php test_sms_api.php
```

**这会显示**：
- ✅ 完整的请求参数
- ✅ 签名生成过程
- ✅ **API的原始响应**（这是关键）
- ✅ 具体的错误代码和错误信息

---

## 📋 可能的错误原因

### 1. 余额不足
```json
{
  "code": 1003,
  "message": "insufficient balance"
}
```
**解决**：充值短信余额

### 2. 手机号格式错误
```json
{
  "code": 1004,
  "message": "invalid phone number"
}
```
**解决**：检查手机号格式

### 3. API Key无效
```json
{
  "code": 1001,
  "message": "invalid api key"
}
```
**解决**：确认API Key是否正确

### 4. 签名错误
```json
{
  "code": 1002,
  "message": "invalid signature"
}
```
**解决**：检查API Secret

### 5. 内容被拒
```json
{
  "code": 1005,
  "message": "content rejected"
}
```
**解决**：修改短信内容

---

## 🔍 查看日志

### 方法1：查看ThinkPHP日志
```bash
# 查看今天的日志
tail -100 /www/wwwroot/168stoneex.com/Runtime/Logs/Home/$(date +%y_%m_%d).log | grep "短信"

# 查看完整的短信日志
grep -A 5 "\[短信" /www/wwwroot/168stoneex.com/Runtime/Logs/Home/*.log | tail -50
```

### 方法2：查看Nginx错误日志
```bash
tail -50 /var/log/nginx/error.log | grep -i sms
```

---

## 💡 临时调试：添加详细日志

如果日志信息不够详细，可以临时修改代码输出更多信息。

在 `Application/Home/Controller/LoginController.class.php` 的 `sendMobileSms` 方法中，找到这部分（约第313行）：

```php
if ($result['code'] == 1) {
    // ... 成功逻辑
} else {
    $this->ajaxReturn(['code' => 0, 'info' => $result['msg']]);
}
```

**临时修改为**：
```php
if ($result['code'] == 1) {
    // ... 成功逻辑
} else {
    // 返回更详细的错误信息（调试用）
    $this->ajaxReturn([
        'code' => 0, 
        'info' => $result['msg'],
        'debug' => $result  // 临时添加，包含完整响应
    ]);
}
```

然后重新点击"获取验证码"，查看完整的响应。

---

## 🎯 最可能的原因和解决方案

### 原因1：手机号格式问题（最常见）⭐

onbuka.com的 `numbers` 字段可能需要特定格式：

**当前发送的格式**：
```
8613800138000  (去除了+和空格)
```

**可能需要的格式**：
1. `+8613800138000` (带+)
2. `86-13800138000` (带-)
3. `13800138000` (只要号码)
4. `+86 13800138000` (带+和空格)

**快速测试**：
修改 `SmsHelper.class.php` 第49行：

```php
// 测试不同格式
$cleanMobile = str_replace(array(' ', '+'), '', $mobile);  // 当前
// 或
$cleanMobile = $mobile;  // 保持原样
// 或  
$cleanMobile = str_replace(' ', '', $mobile);  // 只去空格，保留+
```

---

### 原因2：内容长度限制

短信内容可能有长度限制。

**当前内容**：
```
您的验证码是：123456，5分钟内有效，请勿泄露给他人。
```

**字符数**：约30个汉字

**测试更短的内容**：
修改 `Application/Common/Conf/sms.php` 第10行：

```php
'SMS_TEMPLATE' => '验证码：{code}',  // 更短的模板
```

---

### 原因3：senderId和orderId

官方Demo中这两个字段是空字符串，但可能需要特定值。

**当前**：
```php
'senderId' => '',
'orderId' => '',
```

**可能需要**：
```php
'senderId' => 'YourSenderID',  // 从onbuka后台获取
'orderId' => uniqid(),  // 唯一订单号
```

---

## 🚨 紧急测试方案

### 方案1：使用演示模式
如果短信一直调不通，可以临时启用演示模式：

在 `index.php` 中：
```php
define('MOBILE_CODE', 0);  // 改为0启用演示模式
```

然后验证码会直接显示在前端（调试模式下）。

### 方案2：降级到邮箱验证
暂时使用邮箱注册功能。

---

## 📞 联系技术支持

如果测试脚本显示API返回错误，建议联系onbuka.com技术支持：

**需要提供的信息**：
1. API Key: `JN85gvcv`
2. App ID: `cs_2fii8n`
3. 测试手机号：`+86 13800138000`
4. 错误信息：（从测试脚本获取）
5. 请求参数：（从测试脚本获取）
6. 完整响应：（从测试脚本获取）

---

## ✅ 立即执行

### 第1步：运行测试脚本（最重要）⭐
```bash
php /www/wwwroot/168stoneex.com/test_sms_api.php
```

### 第2步：查看Runtime日志
```bash
tail -100 /www/wwwroot/168stoneex.com/Runtime/Logs/Home/$(date +%y_%m_%d).log
```

### 第3步：将测试脚本的完整输出发给我

我会根据**实际的API错误响应**来进一步调整代码。

---

**重要**：请务必运行测试脚本并提供完整输出，这样我才能看到API返回的具体错误信息！

---

**创建时间**：2026年1月5日  
**状态**：等待测试脚本输出

